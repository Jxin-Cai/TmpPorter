package com.jxin.plug.core.level.repository;

import com.google.common.collect.Maps;
import com.intellij.openapi.components.PersistentStateComponent;
import com.intellij.openapi.components.State;
import com.intellij.openapi.components.Storage;
import com.jxin.plug.core.level.mode.Node;
import lombok.*;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;

/**
 * 节点仓储层
 * @author Jxin
 * @since 2021/7/28 8:55 下午
 */
@State(name = "nodeRepository", storages = @Storage("level-tmp.xml"))
@EqualsAndHashCode
public class NodeRepository implements PersistentStateComponent<NodeRepository.State> , INodeRepository{
    private static final Map<String, String> INIT_MAP;
    static {
        INIT_MAP = Maps.newHashMap();
        INIT_MAP.put("ddd-top", "{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top\",\"basePackage\":\"com.jxin.plug.core.level.tmp.top\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/ohs\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/ohs/job\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/ohs/job/package-info.java\",\"context\":\"/**\\n *\\n * 调度任务层\\n * 执行调度任务\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.ohs.job;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"job\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/ohs/subscriber\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/ohs/subscriber/package-info.java\",\"context\":\"/**\\n *\\n * 订阅层\\n * 消费事件消息\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.ohs.subscriber;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"subscriber\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/ohs/resource\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/ohs/resource/package-info.java\",\"context\":\"/**\\n *\\n * resource\\n * 提供服务资源模型的服务,一般就是restful风格的http服务\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.ohs.resource;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"resource\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/ohs/rpc\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/ohs/rpc/package-info.java\",\"context\":\"/**\\n *\\n * rpc\\n * 提供服务行为模型的rpc服务\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.ohs.rpc;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"rpc\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/ohs/package-info.java\",\"context\":\"/**\\n *\\n * 接入层\\n * 访问服务的接入层(北向网关)\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.ohs;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"ohs\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/application\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/application/assembler\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/application/assembler/package-info.java\",\"context\":\"/**\\n * 转换层\\n * dto -> param\\n * entity -> dto\\n * val -> dto\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.application.assembler;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"assembler\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/application/weaver\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/application/weaver/package-info.java\",\"context\":\"/**\\n * 编排者\\n * 用于编排聚合实体和领域服务实现特定场景的一系列能力\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.application.weaver;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"weaver\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/application/package-info.java\",\"context\":\"/**\\n * 应用层\\n * 用于定义服务一个个应用场景以及每个场景需要的能力\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.application;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"application\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/infrastructure\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/infrastructure/aop\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/infrastructure/aop/package-info.java\",\"context\":\"/**\\n *\\n * 切面层\\n * 1.为服务做一些 global 的操作\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.infrastructure.aop;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"aop\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/infrastructure/lib\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/infrastructure/lib/package-info.java\",\"context\":\"/**\\n *\\n * 程序库\\n * 注: 可被全局所有地方引用。\\n * 这些代码理应抽成公共core/common包,\\n * 但我们不是每次都会去抽,\\n * 留一个统一的层级方便后续提取\\n * 1.提炼一些纯代码级别的工具内。 仅用于简化代码\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.infrastructure.lib;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"lib\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/infrastructure/plug\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/infrastructure/plug/package-info.java\",\"context\":\"/**\\n *\\n * 插件层\\n * 1.独立的技术模块引入时的配置\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.infrastructure.plug;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"plug\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/infrastructure/package-info.java\",\"context\":\"/**\\n *\\n * 基础层\\n * 1.外部框架的依赖 (代码级别)\\n * 2.外部中间件服务的依赖 (进程级别)(南向网关)(我把这一块收到聚合层里,随聚合走,利于聚合的重组)\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.infrastructure;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"infrastructure\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/aggregation\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/aggregation/package-info.java\",\"context\":\"/**\\n *\\n * 聚合层\\n * 包括:\\n * 聚合根实体,\\n * 聚合的事件发布机(状态变更发布事件),\\n * 聚合的持久化实体(状态持久化),\\n * 聚合的创建工厂(实例创建)\\n * @author Jxin\\n * @version 1.0\\n * @since 2020/9/4 20:32\\n */\\npackage com.jxin.plug.core.level.tmp.top.domain.aggregation;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"aggregation\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/err\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/err/package-info.java\",\"context\":\"/**\\n * 异常层\\n * 用于定义业务模型异常流程的异常类\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.domain.service.err;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"err\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/param\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/param/package-info.java\",\"context\":\"/**\\n *\\n * 内部参数\\n * 普通内部类:\\n * 1.规避过长参数列表\\n * 2.隔离外部依赖\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.domain.service.param;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"param\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/acl\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/acl/param\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/acl/param/package-info.java\",\"context\":\"/**\\n *\\n * 内部参数\\n * 普通内部类:\\n * 1.规避过长参数列表\\n * 2.隔离外部依赖\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.domain.service.acl.param;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"param\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/acl/supplier\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/acl/supplier/package-info.java\",\"context\":\"/**\\n *\\n * 供应商层\\n * 防腐层的真实实现\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.domain.service.acl.supplier;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"supplier\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/acl/consts\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/acl/consts/package-info.java\",\"context\":\"/**\\n * 常量层\\n * 防腐层会定义一些模型 也会涉及一些常量\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.domain.service.acl.consts;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"consts\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/acl/package-info.java\",\"context\":\"/**\\n * 防腐层\\n * 用于定义不受当前项目控制的能力（往往就是需要外部进程支撑的能力）（属于南向网关）\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.domain.service.acl;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"acl\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/service/package-info.java\",\"context\":\"/**\\n *\\n * 领域服务层\\n * 领域服务的维度与聚合是平级\\n *\\n * 推到模型的顺序（领域服务应该放在最后，作为不得不才用的存在）：\\n * 值对象（Value Object）→ 实体（Entity）→ 领域服务（Domain Service）\\n *\\n * 建议\\n * 任何服务对象在其名称中必须包含一个动词, 以防出现 ${聚合名}Service 这种无明确意义的领域服务定义\\n * @author Jxin\\n * @version 1.0\\n * @since 2020/9/4 20:32\\n */\\npackage com.jxin.plug.core.level.tmp.top.domain.service;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"service\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/top/domain/package-info.java\",\"context\":\"/**\\n * 领域层\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.top.domain;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"domain\",\"type\":\"DIR\"}],\"dir\":false,\"name\":\"top\",\"type\":\"ROOT\"}");
        INIT_MAP.put("ddd-aggregation", "{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation\",\"basePackage\":\"com.jxin.plug.core.level.tmp.aggregation\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository/param\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository/param/package-info.java\",\"context\":\"/**\\n *\\n * 内部参数\\n * 普通内部类:\\n * 1.规避过长参数列表\\n * 2.隔离外部依赖\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.repository.param;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"param\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository/supplier\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository/supplier/assembler\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository/supplier/assembler/package-info.java\",\"context\":\"/**\\n *\\n * 转换层\\n * Do <-> aggregation\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.repository.supplier.assembler;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"assembler\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository/supplier/mapper\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository/supplier/mapper/package-info.java\",\"context\":\"/**\\n *\\n * DAO 层\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.repository.supplier.mapper;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"mapper\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository/supplier/table\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository/supplier/table/package-info.java\",\"context\":\"/**\\n *\\n * DO 层\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.repository.supplier.table;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"table\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository/supplier/package-info.java\",\"context\":\"/**\\n *\\n * 供应商层\\n * 仓储层的真实实现\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.repository.supplier;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"supplier\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/repository/package-info.java\",\"context\":\"/**\\n *\\n * 仓储层\\n * 处理聚合的持久化\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.repository;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"repository\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/entity\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/entity/consts\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/entity/consts/package-info.java\",\"context\":\"/**\\n * 常量层\\n * 常量收于聚合内部\\n * 聚合内部的常量不该发散到外部去感知\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.entity.consts;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"consts\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/entity/val\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/entity/val/package-info.java\",\"context\":\"/**\\n * 值对象\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.entity.val;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"val\",\"type\":\"DIR\"}],\"dir\":true,\"name\":\"entity\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/err\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/err/package-info.java\",\"context\":\"/**\\n * 异常层\\n * 用于定义业务模型异常流程的异常类\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.err;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"err\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/event\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/event/supplier\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/event/supplier/assembler\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/event/supplier/assembler/package-info.java\",\"context\":\"/**\\n *\\n * 转换层\\n * aggregation -> eventMsg\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.event.supplier.assembler;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"assembler\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/event/supplier/msg\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/event/supplier/msg/package-info.java\",\"context\":\"/**\\n *\\n * 事件消息\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.event.supplier.msg;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"msg\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/event/supplier/package-info.java\",\"context\":\"/**\\n *\\n * 供应商层\\n * 事件层的真实实现\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.event.supplier;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"supplier\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/event/package-info.java\",\"context\":\"/**\\n *\\n * 事件层\\n * 发布聚合状态事件\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.event;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"event\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/acl\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/acl/param\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/acl/param/package-info.java\",\"context\":\"/**\\n *\\n * 内部参数\\n * 普通内部类:\\n * 1.规避过长参数列表\\n * 2.隔离外部依赖\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.acl.param;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"param\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/acl/supplier\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/acl/supplier/package-info.java\",\"context\":\"/**\\n *\\n * 供应商层\\n * 防腐层的真实实现\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.acl.supplier;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"supplier\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/acl/consts\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/acl/consts/package-info.java\",\"context\":\"/**\\n * 常量层\\n * 防腐层会定义一些模型 也会涉及一些常量\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.acl.consts;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"consts\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/acl/package-info.java\",\"context\":\"/**\\n * 防腐层\\n * 用于定义不受当前项目控制的能力（往往就是需要外部进程支撑的能力）（属于南向网关）\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.acl;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"acl\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/factory\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/factory/param\",\"childNode\":[{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/factory/param/package-info.java\",\"context\":\"/**\\n *\\n * 内部参数\\n * 普通内部类:\\n * 1.规避过长参数列表\\n * 2.隔离外部依赖\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.factory.param;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"param\",\"type\":\"DIR\"},{\"absolutePath\":\"/Users/jxin/javaPro/work/TmpPorter/src/test/java/com/jxin/plug/core/level/tmp/aggregation/factory/package-info.java\",\"context\":\"/**\\n *\\n * 工厂层\\n * 用于处理聚合实例的创建\\n * @author Jxin\\n */\\npackage com.jxin.plug.core.level.tmp.aggregation.factory;\",\"dir\":false,\"name\":\"package-info.java\",\"type\":\"FILE\"}],\"dir\":true,\"name\":\"factory\",\"type\":\"DIR\"}],\"dir\":false,\"name\":\"aggregation\",\"type\":\"ROOT\"}");

    }
    @Setter
    private State state = new State(Maps.newHashMap(INIT_MAP));
    @Nullable
    @Override
    public State getState() {
        return state;
    }

    @Override
    public void loadState(@NotNull State state) {
        this.state = state;
    }
    @Override
    public Set<String> allTmpKey(){
        return getLevelTmpRep().keySet();
    }

    @Override
    public Set<String> allTmpKeyWithoutInitKey() {
        return getLevelTmpRep().keySet().stream().filter(key -> !INIT_MAP.containsKey(key)).collect(Collectors.toSet());
    }

    @Override
    public Node get(String key) {
        return Optional.ofNullable(getLevelTmpRep().get(key))
                        .map(Node::of)
                        .orElse(null);
    }
    @Override
    public void remove(String key) {
        getLevelTmpRep().remove(key);
        initState();
    }
    @Override
    public void add(String key, Node node) {
        getLevelTmpRep().put(key, node.dump());
        initState();
    }

    private void initState() {
        state = new State(getLevelTmpRep());
    }

    private Map<String, String> getLevelTmpRep(){
        return state.levelTmpRep;
    }
    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    static class State{
        private Map<String, String> levelTmpRep = Maps.newHashMap();
    }
}
